<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>画像結合ツール</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-8">
  <div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">画像結合ツール</h1>
        <p class="text-gray-600">
          画像をアップロードして4列のグリッドに配置できます。ドラッグ＆ドロップで並び替えが可能です。
        </p>
      </div>

      <!-- Upload Section -->
      <div 
        id="dropZone"
        class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-8 text-center">
        <input
          type="file"
          id="fileInput"
          multiple
          accept="image/*"
          class="hidden"
        />
        <button
          onclick="document.getElementById('fileInput').click()"
          class="inline-flex items-center justify-center space-x-2 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span>画像をアップロード</span>
        </button>
        <p class="text-gray-500 mt-2">または画像をドラッグ＆ドロップ</p>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-center gap-4 mb-8">
        <button
          id="sortBtn"
          class="inline-flex items-center justify-center space-x-2 bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5h4"/><path d="M11 9h7"/><path d="M11 13h10"/><path d="m3 17 3 3 3-3"/><path d="M6 18V4"/></svg>
          <span>日付順ソート</span>
        </button>
        <button
          id="previewBtn"
          class="inline-flex items-center justify-center space-x-2 bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 6v12a3 3 0 1 0 3-3H6a3 3 0 1 0 3 3V6a3 3 0 1 0-3 3h12a3 3 0 1 0-3-3"/></svg>
          <span>プレビュー</span>
        </button>
        <button
          id="saveBtn"
          class="inline-flex items-center justify-center space-x-2 bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          <span>保存</span>
        </button>
      </div>

      <!-- Image Grid -->
      <div id="imageGrid" class="grid grid-cols-4 gap-4"></div>

      <!-- Instructions -->
      <div id="instructions" class="hidden mt-8 p-4 bg-blue-50 rounded-lg">
        <div class="flex items-center space-x-2 text-blue-700">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l14 0"/><path d="M5 15l14 0"/></svg>
          <p>画像をドラッグ＆ドロップで並び替えることができます</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-gray-400 mb-4"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" y1="5" x2="22" y2="5"/><line x1="19" y1="2" x2="19" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        <p class="text-gray-500">画像をアップロードしてください</p>
      </div>

      <!-- Preview Modal -->
      <div id="previewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg p-8 max-w-7xl w-full max-h-[90vh] overflow-auto">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">プレビュー</h2>
            <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
          </div>
          <div id="previewContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let images = [];
    let draggedItem = null;

    // DOM Elements
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const imageGrid = document.getElementById('imageGrid');
    const instructions = document.getElementById('instructions');
    const emptyState = document.getElementById('emptyState');
    const previewBtn = document.getElementById('previewBtn');
    const saveBtn = document.getElementById('saveBtn');
    const sortBtn = document.getElementById('sortBtn');
    const previewModal = document.getElementById('previewModal');
    const previewContent = document.getElementById('previewContent');

    // 日付フォーマット関数
    function formatDate(date) {
      if (!date) return '';
      const d = new Date(date);
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    // ファイル選択ハンドラー
    async function handleFileSelect(e) {
      const files = Array.from(e.target.files || []);
      await addNewImages(files);
    }

    // ドロップハンドラー
    async function handleDrop(e) {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);
      await addNewImages(files);
    }

    // 画像追加処理
    async function addNewImages(files) {
      const imageFiles = files.filter(file => file.type.startsWith('image/'));
      const newImages = await Promise.all(imageFiles.map(async file => {
        const date = await getImageDate(file);
        return {
          id: Math.random().toString(36).substring(7),
          url: URL.createObjectURL(file),
          file,
          date
        };
      }));
      
      images = [...images, ...newImages];
      updateUI();
    }

    // 画像の作成日時を取得
    async function getImageDate(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const view = new DataView(e.target.result);
          try {
            let offset = 2;
            while (offset < view.byteLength) {
              if (view.getUint16(offset) === 0xFFE1) {
                const exifLength = view.getUint16(offset + 2) + 2;
                const tiffOffset = offset + 10;
                if (view.getUint32(tiffOffset) === 0x45786966) {
                  const dateTimeOffset = tiffOffset + 8;
                  const dateTime = new Date(file.lastModified);
                  resolve(dateTime);
                  return;
                }
                offset += exifLength;
              } else {
                break;
              }
            }
            resolve(new Date(file.lastModified));
          } catch (error) {
            resolve(new Date(file.lastModified));
          }
        };
        reader.readAsArrayBuffer(file.slice(0, 128 * 1024));
      });
    }

    // 日付順ソート
    function sortByDate() {
      images.sort((a, b) => a.date - b.date);
      updateUI();
    }

    // UI更新
    function updateUI() {
      previewBtn.disabled = images.length === 0;
      saveBtn.disabled = images.length === 0;
      sortBtn.disabled = images.length === 0;
      instructions.style.display = images.length > 0 ? 'block' : 'none';
      emptyState.style.display = images.length === 0 ? 'block' : 'none';
      
      imageGrid.innerHTML = '';
      images.forEach((image, index) => {
        const div = document.createElement('div');
        div.className = 'relative group border border-gray-200 rounded-lg overflow-hidden';
        div.style.paddingBottom = '100%';
        div.draggable = true;
        
        div.innerHTML = `
          <div class="absolute inset-0">
            <img
              src="${image.url}"
              alt="Image ${index + 1}"
              class="w-full h-full object-contain bg-gray-100"
            />
            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
              <button
                onclick="removeImage(${index})"
                class="p-2 bg-red-500 rounded-full text-white hover:bg-red-600 transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
              </button>
            </div>
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white px-3 py-4 text-base">
              ${formatDate(image.date)}
            </div>
          </div>
        `;

        div.addEventListener('dragstart', () => draggedItem = index);
        div.addEventListener('dragover', (e) => e.preventDefault());
        div.addEventListener('drop', (e) => {
          e.preventDefault();
          if (draggedItem === null) return;
          
          const newImages = [...images];
          const [draggedImage] = newImages.splice(draggedItem, 1);
          newImages.splice(index, 0, draggedImage);
          
          images = newImages;
          draggedItem = null;
          updateUI();
        });

        imageGrid.appendChild(div);
      });
    }

    function removeImage(index) {
      images.splice(index, 1);
      updateUI();
    }

    // プレビュー機能
    function showPreview() {
      if (images.length === 0) return;

      createCombinedPreview().then(previewUrl => {
        const img = document.createElement('img');
        img.src = previewUrl;
        img.className = 'w-full h-auto';
        
        previewContent.innerHTML = '';
        previewContent.appendChild(img);
        previewModal.style.display = 'flex';
      });
    }

    function closePreview() {
      previewModal.style.display = 'none';
    }

    // 画像結合処理
    async function createCombinedPreview() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const dateHeight = 100; // 日付の高さを大きな解像度に合わせて調整
      const cols = 4;
      const rows = Math.ceil(images.length / cols);

      // 最初の画像のアスペクト比を基準にする
      const firstImg = await new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.src = images[0].url;
      });

      const baseAspectRatio = firstImg.width / firstImg.height;
      const baseWidth = 5000 / cols; // 1列あたりの幅を5000pxの1/4に
      const baseHeight = baseWidth / baseAspectRatio;

      canvas.width = baseWidth * cols;
      canvas.height = (baseHeight + dateHeight) * rows;

      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      await Promise.all(images.map(async (image, index) => {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const row = Math.floor(index / cols);
            const col = index % cols;
            const x = col * baseWidth;
            const y = row * (baseHeight + dateHeight);

            const imgAspectRatio = img.width / img.height;
            let drawWidth = baseWidth;
            let drawHeight = baseHeight;

            if (imgAspectRatio > baseAspectRatio) {
              drawHeight = drawWidth / imgAspectRatio;
              const yOffset = (baseHeight - drawHeight) / 2;
              ctx.drawImage(img, x, y + yOffset, drawWidth, drawHeight);
            } else {
              drawWidth = drawHeight * imgAspectRatio;
              const xOffset = (baseWidth - drawWidth) / 2;
              ctx.drawImage(img, x + xOffset, y, drawWidth, drawHeight);
            }

            const cellBottom = y + baseHeight;
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(x, cellBottom, baseWidth, dateHeight);
            
            ctx.fillStyle = 'white';
            ctx.font = '54px Arial'; // フォントサイズを大きな解像度に合わせて調整
            ctx.textAlign = 'center';
            ctx.fillText(formatDate(image.date), x + baseWidth / 2, cellBottom + 65); // 位置調整

            resolve();
          };
          img.src = image.url;
        });
      }));

      // JPEGフォーマットで出力（画質0.9で高品質を維持）
      return canvas.toDataURL('image/jpeg', 0.9);
    }

    // イベントリスナー
    fileInput.addEventListener('change', handleFileSelect);
    dropZone.addEventListener('dragover', (e) => e.preventDefault());
    dropZone.addEventListener('drop', handleDrop);
    previewBtn.addEventListener('click', showPreview);
    sortBtn.addEventListener('click', sortByDate);
    saveBtn.addEventListener('click', async function() {
      if (images.length === 0) return;
      const dataUrl = await createCombinedPreview();
      const link = document.createElement('a');
      link.download = 'combined-images.jpg';
      link.href = dataUrl;
      link.click();
    });
  </script>
</body>
</html>